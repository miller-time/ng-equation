"use strict";angular.module("ngEquation",["ui.bootstrap","ngEquation.templates"]),angular.module("ngEquation").controller("EquationCtrl",function(){var a=this;if(a.topLevelGroup={operator:"AND",operands:[],onReady:function(b){a.groupApi=b}},a.value=function(){var b;return a.groupApi&&(b=a.groupApi.value()),b},angular.isFunction(a.onReady)){var b={value:a.value};a.onReady({equationApi:b})}}).directive("equation",["$templateCache",function(a){return{restrict:"EA",scope:{},transclude:{toolboxLabel:"?toolboxLabel"},bindToController:{options:"=equationOptions","class":"@equationClass",onReady:"&"},controller:"EquationCtrl",controllerAs:"equation",template:a.get("equation.html")}}]),angular.module("ngEquation").controller("ExpressionGroupCtrl",function(){function a(c){var d;return d=b.isSubgroup(c)?{operator:c.operator,children:c.operands.map(function(b){return a(b)})}:{itemType:c["class"],id:c.value,label:c.getLabel(c)}}var b=this;if(b.addOperand=function(a){b.operands.push(angular.copy(a))},b.addSubgroup=function(){b.addOperand({operator:"AND",operands:[]})},b.isSubgroup=function(a){return!!a.operands},b.getIndexOfOperand=function(a){if(!b.isSubgroup(a))for(var c=0,d=b.operands.length;c<d;c++)if(!b.isSubgroup(b.operands[c])&&b.operands[c].value===a.value)return c;return-1},b.removeSubgroup=function(a){b.operands.splice(a,1)},b.removeOperand=function(a){var c=b.getIndexOfOperand(a);c!==-1&&b.operands.splice(c,1)},b.value=function(){return{operator:b.operator,children:b.operands.map(function(b){return a(b)})}},angular.isFunction(b.onReady)){var c={value:b.value};b.onReady({groupApi:c})}}).directive("expressionGroup",["$compile","$templateCache","expressionGroupDragNDrop",function(a,b,c){return{restrict:"EA",scope:{},bindToController:{parent:"=?",subgroupId:"@",operator:"=",operands:"=",availableOperands:"=",onReady:"&"},controller:"ExpressionGroupCtrl",controllerAs:"group",compile:function(b){var d,e=b.contents().remove();return{post:function(b,f){d||(d=a(e)),d(b,function(a){f.append(a)}),c.setup(b,f)}}},template:b.get("expression-group.html")}}]),angular.module("ngEquation").controller("ExpressionOperandToolboxCtrl",function(){}).directive("expressionOperandToolbox",["$templateCache",function(a){return{restrict:"EA",scope:{},bindToController:{operands:"="},controller:"ExpressionOperandToolboxCtrl",controllerAs:"toolbox",template:a.get("expression-operand-toolbox.html")}}]),angular.module("ngEquation").factory("operandOptions",function(){function a(a){this.error='Operand options missing required property "'+a+'".'}function b(a,b,c){this.error='Operand options property "'+a+'" is incorrect type. Expected: "'+b+'". Got: "'+c+'".'}var c={"class":"string",typeLabel:"string",editMetadata:"function",getLabel:"function"};return{validate:function(d){angular.forEach(c,function(c,e){if(!d[e])throw new a(e);if(typeof d[e]!==c)throw new b(e,c,(typeof d[e]))})}}}).controller("ExpressionOperandCtrl",["$q","operandOptions",function(a,b){var c=this;b.validate(c.options);var d=angular.isDefined(c.options.value);c.removeFromGroup=function(){c.group&&c.group.removeOperand(c.options)},c.editMetadata=function(){var b=c.options.editMetadata();a.when(b).then(function(a){angular.isDefined(a)?(c.options.value=a,d=!0):d||c.removeFromGroup()},function(){d||c.removeFromGroup()})},c.group&&angular.isUndefined(c.options.value)&&c.editMetadata()}]).directive("expressionOperand",["$templateCache","expressionOperandDragNDrop",function(a,b){return{restrict:"EA",scope:{},bindToController:{group:"=?",options:"=operandOptions"},controller:"ExpressionOperandCtrl",controllerAs:"operand",link:function(a,c){b.setup(a,c)},template:a.get("expression-operand.html")}}]),angular.module("ngEquation").factory("expressionGroupDragNDrop",["$window",function(a){return{setup:function(b,c){a.interact(c.find(".eq-new-operand")[0]).dropzone({accept:".eq-operand",overlap:.1,checker:function(a,b,c,d,e,f,g){var h=angular.element(g).scope().operand,i=angular.element(e).scope();if(i){var j=angular.element(e).scope().group;return c&&j.getIndexOfOperand(h.options)===-1}return!1},ondropactivate:function(a){a.target.classList.add("drop-active")},ondragenter:function(b){b.target.classList.add("drop-target"),b.relatedTarget.classList.add("can-drop");var c=a.interact.getElementRect(b.target),d={x:c.left+c.width/2,y:c.top+c.height/2};b.draggable.draggable({snap:{targets:[d]}})},ondragleave:function(a){a.target.classList.remove("drop-target"),a.relatedTarget.classList.remove("can-drop"),a.draggable.draggable({snap:{targets:[{x:parseFloat(a.relatedTarget.getAttribute("data-start-x")),y:parseFloat(a.relatedTarget.getAttribute("data-start-y"))}]}})},ondrop:function(a){a.relatedTarget.classList.remove("can-drop");var c=angular.element(a.relatedTarget).scope().operand,d=angular.element(a.target).scope().group;if(b.$apply(function(){d.addOperand(c.options)}),c.group)b.$apply(function(){c.removeFromGroup()});else{var e=a.relatedTarget;a.draggable.draggable({snap:{targets:[{x:parseFloat(e.getAttribute("data-start-x")),y:parseFloat(e.getAttribute("data-start-y"))}]}}),e.style.webkitTransform=e.style.transform="none",e.setAttribute("data-x",0),e.setAttribute("data-y",0)}},ondropdeactivate:function(a){a.target.classList.remove("drop-active"),a.target.classList.remove("drop-target")}})}}}]),angular.module("ngEquation").factory("expressionOperandDragNDrop",["$window",function(a){return{setup:function(b,c){var d=c.find(".eq-operand")[0];a.interact(d).draggable({autoScroll:!0,snap:{range:1/0,relativePoints:[{x:.5,y:.5}],endOnly:!0},onstart:function(b){var c=parseFloat(b.target.getAttribute("data-start-x")),d=parseFloat(b.target.getAttribute("data-start-y"));if(isNaN(c)||isNaN(d)){var e=a.interact.getElementRect(b.target);c=e.left+e.width/2,d=e.top+e.height/2,b.target.setAttribute("data-start-x",c),b.target.setAttribute("data-start-y",d),b.interactable.draggable({snap:{targets:[{x:c,y:d}]}})}},onmove:function(a){var b=a.target,c=(parseFloat(b.getAttribute("data-x"))||0)+a.dx,d=(parseFloat(b.getAttribute("data-y"))||0)+a.dy;b.style.webkitTransform=b.style.transform="translate("+c+"px, "+d+"px)",b.setAttribute("data-x",c),b.setAttribute("data-y",d)}}).dropzone({accept:".eq-operand",checker:function(a,b,c,d,e,f,g){var h=angular.element(e).scope();if(h){var i=h.operand;if(c&&i){var j=angular.element(g).scope().operand;return c&&i.options.value!==j.options.value}}return!1},ondropactivate:function(a){a.target.classList.add("drop-active")},ondragenter:function(b){b.target.classList.add("drop-target"),b.relatedTarget.classList.add("can-drop");var c=a.interact.getElementRect(b.target),d={x:c.left+c.width/2,y:c.top+c.height/2};b.draggable.draggable({snap:{targets:[d]}})},ondragleave:function(a){a.target.classList.remove("drop-target"),a.relatedTarget.classList.remove("can-drop"),a.draggable.draggable({snap:{targets:[{x:parseFloat(a.relatedTarget.getAttribute("data-start-x")),y:parseFloat(a.relatedTarget.getAttribute("data-start-y"))}]}})},ondrop:function(a){a.relatedTarget.classList.remove("can-drop");var c=angular.element(a.relatedTarget).scope().operand,d=angular.element(a.target).scope().operand;if(b.$apply(function(){d.group.addOperand({operator:"AND",operands:[d.options,c.options]})}),b.$apply(function(){d.removeFromGroup()}),c.group)b.$apply(function(){c.removeFromGroup()});else{var e=a.relatedTarget;a.draggable.draggable({snap:{targets:[{x:parseFloat(e.getAttribute("data-start-x")),y:parseFloat(e.getAttribute("data-start-y"))}]}}),e.style.webkitTransform=e.style.transform="none",e.setAttribute("data-x",0),e.setAttribute("data-y",0)}},ondropdeactivate:function(a){a.target.classList.remove("drop-active"),a.target.classList.remove("drop-target")}})}}}]);