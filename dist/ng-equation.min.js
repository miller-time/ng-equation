"use strict";angular.module("ngEquation",["ui.bootstrap","ngEquation.templates"]),angular.module("ngEquation").controller("EquationCtrl",function(){var a=this;a.topLevelGroup={operator:"AND",operands:[]}}).directive("equation",["$templateCache",function(a){return{restrict:"EA",scope:{},bindToController:{options:"=equationOptions"},controller:"EquationCtrl",controllerAs:"equation",template:a.get("equation.html")}}]),angular.module("ngEquation").controller("ExpressionGroupCtrl",function(){var a=this;a.addOperand=function(b){a.operands.push(b)},a.addSubgroup=function(){a.addOperand({operator:"AND",operands:[]})},a.getIndexOfOperand=function(b){for(var c=0;c<a.operands.length;++c)if(a.operands[c]["class"]===b["class"]&&a.operands[c].label===b.label)return c;return-1},a.removeSubgroup=function(b){a.operands.splice(b,1)},a.removeOperand=function(b){var c=a.getIndexOfOperand(b);c!==-1&&a.operands.splice(c,1)}}).directive("expressionGroup",["$templateCache",function(a){return{restrict:"EA",scope:{},bindToController:{parent:"=?",subgroupId:"@",operator:"@",operands:"=",availableOperands:"="},controller:"ExpressionGroupCtrl",controllerAs:"group",link:function(a,b){interact(b.find(".eq-new-operand")[0]).dropzone({accept:".eq-operand",checker:function(a,b,c,d,e,f,g){var h=angular.element(g).scope().operand,i=angular.element(e).scope();if(i){var j=angular.element(e).scope().group;return c&&j.getIndexOfOperand(h.options)===-1}return!1},ondropactivate:function(a){a.target.classList.add("drop-active")},ondragenter:function(a){a.target.classList.add("drop-target"),a.relatedTarget.classList.add("can-drop");var b=interact.getElementRect(a.target),c={x:b.left+b.width/2,y:b.top+b.height/2};a.draggable.draggable({snap:{targets:[c]}})},ondragleave:function(a){a.target.classList.remove("drop-target"),a.relatedTarget.classList.remove("can-drop"),a.draggable.draggable({snap:{targets:[{x:parseFloat(a.relatedTarget.getAttribute("data-start-x")),y:parseFloat(a.relatedTarget.getAttribute("data-start-y"))}]}})},ondrop:function(b){b.relatedTarget.classList.remove("can-drop");var c=angular.element(b.relatedTarget).scope().operand,d=angular.element(b.target).scope().group;if(a.$apply(function(){d.addOperand(c.options)}),c.group)a.$apply(function(){c.removeFromGroup()});else{var e=b.relatedTarget;b.draggable.draggable({snap:{targets:[{x:parseFloat(e.getAttribute("data-start-x")),y:parseFloat(e.getAttribute("data-start-y"))}]}}),e.style.webkitTransform=e.style.transform="none",e.setAttribute("data-x",0),e.setAttribute("data-y",0)}},ondropdeactivate:function(a){a.target.classList.remove("drop-active"),a.target.classList.remove("drop-target")}})},template:a.get("expression-group.html")}}]),angular.module("ngEquation").controller("ExpressionOperandToolboxCtrl",function(){}).directive("expressionOperandToolbox",["$templateCache",function(a){return{restrict:"EA",scope:{},bindToController:{operands:"="},controller:"ExpressionOperandToolboxCtrl",controllerAs:"toolbox",template:a.get("expression-operand-toolbox.html")}}]),angular.module("ngEquation").controller("ExpressionOperandCtrl",function(){var a=this;a.removeFromGroup=function(){a.group&&a.group.removeOperand(a.options)}}).directive("expressionOperand",["$templateCache",function(a){return{restrict:"EA",scope:{},bindToController:{group:"=?",options:"=operandOptions"},controller:"ExpressionOperandCtrl",controllerAs:"operand",link:function(a,b){var c=b.find(".eq-operand")[0];interact(c).draggable({autoScroll:!0,snap:{range:1/0,relativePoints:[{x:.5,y:.5}],endOnly:!0},onstart:function(a){var b=parseFloat(a.target.getAttribute("data-start-x")),c=parseFloat(a.target.getAttribute("data-start-y"));if(isNaN(b)||isNaN(c)){var d=interact.getElementRect(a.target);b=d.left+d.width/2,c=d.top+d.height/2,a.target.setAttribute("data-start-x",b),a.target.setAttribute("data-start-y",c),a.interactable.draggable({snap:{targets:[{x:b,y:c}]}})}},onmove:function(a){var b=a.target,c=(parseFloat(b.getAttribute("data-x"))||0)+a.dx,d=(parseFloat(b.getAttribute("data-y"))||0)+a.dy;b.style.webkitTransform=b.style.transform="translate("+c+"px, "+d+"px)",b.setAttribute("data-x",c),b.setAttribute("data-y",d)}}).dropzone({accept:".eq-operand",checker:function(a,b,c,d,e,f,g){var h=angular.element(e).scope();if(h){var i=h.operand;if(c&&i){var j=angular.element(g).scope().operand;return c&&(i.options["class"]!==j.options["class"]||i.options.label!==j.options.label)}}return!1},ondropactivate:function(a){a.target.classList.add("drop-active")},ondragenter:function(a){a.target.classList.add("drop-target"),a.relatedTarget.classList.add("can-drop");var b=interact.getElementRect(a.target),c={x:b.left+b.width/2,y:b.top+b.height/2};a.draggable.draggable({snap:{targets:[c]}})},ondragleave:function(a){a.target.classList.remove("drop-target"),a.relatedTarget.classList.remove("can-drop"),a.draggable.draggable({snap:{targets:[{x:parseFloat(a.relatedTarget.getAttribute("data-start-x")),y:parseFloat(a.relatedTarget.getAttribute("data-start-y"))}]}})},ondrop:function(b){b.relatedTarget.classList.remove("can-drop");var c=angular.element(b.relatedTarget).scope().operand,d=angular.element(b.target).scope().operand;if(a.$apply(function(){d.group.addOperand({operator:"AND",operands:[d.options,c.options]})}),a.$apply(function(){d.removeFromGroup()}),c.group)a.$apply(function(){c.removeFromGroup()});else{var e=b.relatedTarget;b.draggable.draggable({snap:{targets:[{x:parseFloat(e.getAttribute("data-start-x")),y:parseFloat(e.getAttribute("data-start-y"))}]}}),e.style.webkitTransform=e.style.transform="none",e.setAttribute("data-x",0),e.setAttribute("data-y",0)}},ondropdeactivate:function(a){a.target.classList.remove("drop-active"),a.target.classList.remove("drop-target")}})},template:a.get("expression-operand.html")}}]);